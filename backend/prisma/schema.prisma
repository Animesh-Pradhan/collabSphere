generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                       String               @id @default(cuid())
  firstName                String
  lastName                 String
  email                    String               @unique
  mobileNo                 String?              @unique @db.VarChar(10)
  password                 String?
  avatar                   String?
  username                 String?              @unique
  lastActiveOrganisationId String?
  //AUTH
  isEmailVerified          Boolean              @default(false)
  isMobileVerified         Boolean              @default(false)
  lastLoginAt              DateTime?
  signupSource             String               @default("email")
  twoFactorAuthentication  Boolean              @default(false)
  //SSO
  googleId                 String?              @unique
  facebookId               String?              @unique
  microsoftId              String?              @unique
  //SECURITY
  failedAttempts           Int                  @default(0)
  lockedUntil              DateTime?
  //ONBARDING
  isOnboarded              Boolean              @default(false)
  onBoardingStep           Int                  @default(1)
  //AUDIT
  createdAt                DateTime             @default(now())
  updatedAt                DateTime             @updatedAt
  deletedAt                DateTime?
  membership               OrganisationMember[]
  userDevice               UserDevice[]
  userSessions             UserSession[]
  notificatios             Notification[]
  emailOtps                EmailOtp[]
  workspaceMembers         WorkspaceMember[]
  workspaces               Workspace[]

  @@index([mobileNo])
  @@index([email])
  @@index([username])
  @@index([lastLoginAt])
  @@index([signupSource])
  @@index([isOnboarded, onBoardingStep])
  @@index([createdAt])
}

model Organisation {
  id                  String               @id @default(cuid())
  name                String
  logo                String?
  slug                String               @unique
  timezone            String               @default("Asia/Kolkata")
  address             String?
  country             String?
  //BILLING
  plan                String               @default("free")
  billingEmail        String?
  trialEndsAt         DateTime?
  subscriptionId      String?              @unique
  billingStatus       String?              @default("active")
  //SETTINGS
  aiFeature           Boolean              @default(false)
  notification        Boolean              @default(true)
  customDomain        String?              @unique
  //AUDIT
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  deletedAt           DateTime?
  lastActiveAt        DateTime?
  members             OrganisationMember[]
  organisationInvites OrganisationInvite[]
  workspaces          Workspace[]

  @@index([slug])
  @@index([subscriptionId])
  @@index([customDomain])
  @@index([plan])
  @@index([country])
}

enum Role {
  OWNER
  ADMIN
  MANAGER
  MEMBER
  GUEST
}

enum MemberStatus {
  ACTIVE
  SUSPENDED
  REMOVED
}

model OrganisationMember {
  id             String       @id @default(cuid())
  userId         String
  organisationId String
  role           Role         @default(MEMBER)
  status         MemberStatus @default(ACTIVE)
  joinedAt       DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  removedAt      DateTime?
  lastActiveAt   DateTime?
  invitedBy      String?
  invitedAt      DateTime?
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@unique([userId, organisationId])
  @@index([organisationId, role])
  @@index([userId])
  @@index([organisationId])
  @@index([role])
  @@index([status])
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

model OrganisationInvite {
  id             String       @id @default(cuid())
  organisationId String
  email          String
  role           Role         @default(MEMBER)
  tokenHash      String
  status         InviteStatus @default(PENDING)
  expiresAt      DateTime
  invitedBy      String
  invitedAt      DateTime     @default(now())
  acceptedAt     DateTime?

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@index([tokenHash, status])
  @@index([organisationId])
  @@index([email])
  @@index([status])
}

model UserDevice {
  id         String   @id @default(cuid())
  userId     String
  deviceType String
  userAgent  String?
  ipAddress  String?
  lastActive DateTime @default(now())
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lastActive])
}

model UserSession {
  id         String   @id @default(cuid())
  userId     String
  gateToken  String   @unique
  vaultToken String   @unique
  expiresAt  DateTime
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   @default("info")
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, isRead, createdAt])
  @@index([createdAt])
}

model AuditLog {
  id             String   @id @default(cuid())
  userId         String?
  organizationId String?
  action         String
  description    String?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime @default(now())

  @@index([userId])
  @@index([organizationId])
  @@index([action])
  @@index([createdAt])
  @@index([organizationId, createdAt])
}

model EmailOtp {
  id         String    @id @default(cuid())
  userId     String
  email      String
  otpHash    String
  expiresAt  DateTime
  attempts   Int       @default(0)
  verifiedAt DateTime?
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
}

//PHASE-2 MODELS ADDED FROM HERE

enum WorkspaceType {
  PERSONAL
  ORGANISATION
}

model Workspace {
  id             String        @id @default(cuid())
  organisationId String? //NULL = personal workspace
  ownerId        String
  type           WorkspaceType
  name           String
  slug           String?
  description    String?
  isDefault      Boolean       @default(false)
  status         String        @default("active") // active| archived | locked
  eventStreamKey String?
  aiEnabled      Boolean       @default(false)
  aiContext      Json?
  //RATE LIMITING / SAFETY
  writeQuota     Int? // per-day write limits
  readQuota      Int?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime?
  archivedAt     DateTime?

  owner            User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  organisation     Organisation?     @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  workspaceMembers WorkspaceMember[]
  documents        Document[]
  tasks            Task[]

  @@unique([organisationId, slug])
  @@unique([organisationId, isDefault])
  @@index([organisationId])
  @@index([ownerId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

enum WorkspaceRole {
  OWNER
  EDITOR
  COMMENTER
  VIEWER
}

enum WorkspaceMemberStatus {
  ACTIVE
  PENDING
  SUSPENDED
  REMOVED
  LEFT
}

model WorkspaceMember {
  id           String                @id @default(cuid())
  workspaceId  String
  userId       String?
  role         WorkspaceRole         @default(VIEWER)
  status       WorkspaceMemberStatus @default(ACTIVE)
  invitedBy    String?
  invitedAt    DateTime?
  joinedAt     DateTime              @default(now())
  removedAt    DateTime?
  externalId   String?
  source       String                @default("internal")
  permissions  Json?
  lastActiveAt DateTime?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  workspace Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents Document[]

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@index([status])
  @@index([role])
}

enum DocumentStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Document {
  id             String         @id @default(cuid())
  workspaceId    String
  title          String
  description    String?
  status         DocumentStatus @default(DRAFT)
  createdBy      String
  updatedBy      String?
  currentVersion Int            @default(1)
  lockedBy       String?
  lockedAt       DateTime?
  metadata       Json?
  aiContext      Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  publishedAt    DateTime?
  deletedAt      DateTime?

  workspace        Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  lockedMember     WorkspaceMember?  @relation(fields: [lockedBy], references: [id], onDelete: SetNull)
  documentVersions DocumentVersion[]
  documentComments DocumentComment[]

  @@index([workspaceId])
  @@index([status])
  @@index([createdAt])
}

model DocumentVersion {
  id         String   @id @default(uuid())
  documentId String
  version    Int
  content    Json
  createdBy  String
  createdAt  DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, version])
  @@index([documentId])
}

model DocumentComment {
  id         String    @id @default(cuid())
  documentId String
  userId     String
  comment    String
  parentId   String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  REVIEW
  DONE
  ARCHIVED
}

model Task {
  id          String       @id @default(cuid())
  workspaceId String
  createdBy   String
  ownerId     String?
  title       String
  description String?
  priority    TaskPriority @default(MEDIUM)
  status      TaskStatus   @default(TODO)
  dueDate     String?
  metadata    Json?
  aiContext   Json?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  completedAt DateTime?
  deletedAt   DateTime?

  workspace      Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  taskAssignees  TaskAssignee[]
  taskActivities TaskActivity[]

  @@index([workspaceId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
}

model TaskAssignee {
  id         String   @id @default(cuid())
  taskId     String
  userId     String
  assignedBy String?
  assignedAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([userId])
}

model TaskActivity {
  id        String   @id @default(cuid())
  taskId    String
  action    String // STATUS_CHANGED, ASSIGNED, COMMENTED
  payload   Json
  createdBy String
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([action])
  @@index([createdAt])
}

enum SystemEventStatus {
  PENDING
  PROCESSING
  PROCESSED
  FAILED
}

model SystemEvent {
  id            String            @id @default(cuid())
  event         String // DOCUMENT_UPDATED, TASK_ASSIGNED
  aggregateType String // workspace | document | task
  aggregateId   String
  payload       Json
  status        SystemEventStatus @default(PENDING)
  retryCount    Int               @default(0)
  error         String?
  createdAt     DateTime          @default(now())
  processedAt   DateTime?

  @@index([event])
  @@index([aggregateType, aggregateId])
  @@index([status])
  @@index([createdAt])
}
